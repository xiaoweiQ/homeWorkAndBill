<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="../bill.js"></script>
    <script src="../categories.js"></script>
    <link rel="stylesheet" href="./modal.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      table tr th,
      table tr td {
        min-width: 100px;
        border: 1px solid red;
        text-align: center;
      }
      .form-div {
        display: flex;
        margin-bottom: 10px;
        width: 200px
      }
      button {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        height: 32px;
        padding: 8px 15px;
        margin: 2px;
        cursor: pointer;
        color: #fff;
        text-align: center;
        outline: none;
        font-weight: 500;
        user-select: none;
        background-color: #409eff;
        border: none;
        font-size: 14px;
        border-radius: 4px;
      }
      label {
        display: block;
        min-width: 100px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <select class="select"></select>
      <button class="addBill">添加账单</button>
      <div class="modal-wrap">
        <div class="modal">
          <div class="modal_header">
            <div class="modal_header-title">添加账单</div>
            <div class="modal_header-close">x</div>
          </div>
          <div class="modal_content">
            <form class="bill-form">
              <div class="form-div">
                <label>账单类型</label>
                <select class="modal-content_bill-type"></select>
              </div>
              <div class="form-div">
                <label>账单时间</label>
                <select class="modal-content_bill-time"></select>
              </div>
              <div class="form-div">
                <label>账单分类</label>
                <select class="modal-content_bill-category"></select>
              </div>
              <div class="form-div">
                <label>账单金额</label>
                <input type="text" class="modal-content_bill-amount"></input>
              </div>
            </form>
          </div>
          <div class="modal_footer">
            <button class="add-bill-confirm">确定</button>
            <button class="add-bill-cancel">取消</button>
          </div>
        </div>
        <div class="overlay"></div>
      </div>
      <table class="table"></table>
    </div>
    <script type="module">
      import { txtToJson, dispose, deepClone, generateTimerList } from './util.js'
      let billData = txtToJson(billText)
      let categoriesData = txtToJson(categoriesText)
      dispose(billData, categoriesData)
      let copyBillData = deepClone(billData)

      function initTable(data, tableClassName) {
        // 移除旧的table
        let table = document.querySelector(`.${tableClassName}`)
        if (table) {
          let parent = table.parentElement
          parent.removeChild(table)
        }
        // 生成新的table标签
        let wrap = document.querySelector('.wrap')
        let newTable = document.createElement('table')
        newTable.setAttribute('class', 'table')
        wrap.appendChild(newTable)
        const appendTitles = titles => {
          let tr = document.createElement('tr')
          newTable.appendChild(tr)
          titles.forEach(title => {
            let th = document.createElement('th')
            tr.appendChild(th)
            th.innerText = title
          })
        }
        const appendContents = contents => {
          contents.forEach(content => {
            let tr = document.createElement('tr')
            newTable.appendChild(tr)
            for (const key in content) {
              let td = document.createElement('td')
              tr.appendChild(td)
              td.innerText = content[key]
            }
          })
        }
        let titles = data.titles
        let contents = data.data
        appendTitles(titles)
        appendContents(contents)
      }
      function initSelect(selectClassName, data) {
        let select = document.querySelector(`.${selectClassName}`)
        data.forEach(item => {
          let option = document.createElement('option')
          select.appendChild(option)
          option.innerText = item.label
          option.value = item.value
        })
      }
      function bindEvent(className, eventName, cb) {
        let ele = document.querySelector(`.${className}`)
        ele[eventName] = e => {
          cb(e, ele)
        }
      }
      initTable(copyBillData, 'table')
      let monthList = [{ label: '全部', value: -1 }]
      for (let i = 1; i < 13; i++) {
        monthList.push({ label: i, value: i })
      }
      initSelect('select', monthList)
      bindEvent('select', 'onchange', (e, ele) => {
        let selectedIndex = ele.selectedIndex
        let selectedValue = ele.options[selectedIndex].value
        copyBillData.data = billData.data.filter(item => {
          if (Number(selectedValue) === -1) return true
          let timerMonth = item.time.split('-')[1]
          return Number(timerMonth) === Number(selectedValue)
        })
        initTable(copyBillData, 'table')
      })
      bindEvent('addBill', 'onclick', (e, ele) => {
        let modalWrap = document.querySelector('.modal-wrap')
        modalWrap.style.display = 'block'
        let body = document.querySelector('body')
        body.style.overflow = 'hidden'
      })
      const initBillModal = () => {
        let modalWrap = document.querySelector('.modal-wrap')
        let confirmBtn = document.querySelector('.add-bill-confirm')
        // 点击确认后添加元素
        confirmBtn.onclick = (e) => {
          console.log(e)
        }
        const closeModal = () => {
          modalWrap.style.display = 'none'
          let body = document.querySelector('body')
          body.style.overflow = 'auto'
        }
        // 绑定modal中的关闭弹框事件
        bindEvent('modal_header-close', 'onclick', closeModal)
        bindEvent('add-bill-cancel', 'onclick', closeModal)
        bindEvent('overlay', 'onclick', closeModal)
      }
      initBillModal()
      const addBillModalContent = () => {
        // 创建表单
        let modalContent = document.querySelector('.modal_content')
        let form = document.createElement('form')
        form.setAttribute('class', 'bill-form')
        modalContent.appendChild(form)
        // 初始化表单数据
        let billTypeList = [{ label: '支出', value: '0' }, { label: '收入', value: '1' }]
        let billTime = generateTimerList()
        let billCategoryList = categoriesData.data.map(item => {
          return {
            label: item.name,
            value: item.id
          }
        })
        initSelect('modal-content_bill-type', billTypeList)
        initSelect('modal-content_bill-category', billCategoryList)
      }
      addBillModalContent()
    </script>
  </body>
</html>