<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="../bill.js"></script>
    <script src="../categories.js"></script>
    <style>
      table tr th,
      table tr td {
        min-width: 100px;
        border: 1px solid red;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <select class="select"></select>
      <table class="table"></table>
    </div>
    <script type="module">
      import { txtToJson, dispose, deepClone } from './util.js'
      let billData = txtToJson(billText)
      let categoriesData = txtToJson(categoriesText)
      dispose(billData, categoriesData)
      let copyBillData = deepClone(billData)

      function initTable(data, tableClassName) {
        // 移除旧的table
        let table = document.querySelector(`.${tableClassName}`)
        if (table) {
          let parent = table.parentElement
          parent.removeChild(table)
        }
        // 生成新的table标签
        let wrap = document.querySelector('.wrap')
        let newTable = document.createElement('table')
        newTable.setAttribute('class', 'table')
        wrap.appendChild(newTable)
        const appendTitles = titles => {
          let tr = document.createElement('tr')
          newTable.appendChild(tr)
          titles.forEach(title => {
            let th = document.createElement('th')
            tr.appendChild(th)
            th.innerText = title
          })
        }
        const appendContents = contents => {
          contents.forEach(content => {
            let tr = document.createElement('tr')
            newTable.appendChild(tr)
            for (const key in content) {
              let td = document.createElement('td')
              tr.appendChild(td)
              td.innerText = content[key]
            }
          })
        }
        let titles = data.titles
        let contents = data.data
        appendTitles(titles)
        appendContents(contents)
      }
      function initSelect(data, selectClassName) {
        let select = document.querySelector(`.${selectClassName}`)
        data.forEach(item => {
          let option = document.createElement('option')
          select.appendChild(option)
          option.innerText = item.label
          option.value = item.value
        })
      }
      function bindEvent(selectClassName, cb) {
        let select = document.querySelector(`.${selectClassName}`)
        select.onchange = () => {
          let selectedIndex = select.selectedIndex
          let selectedValue = select.options[selectedIndex].value
          cb(selectedValue)
        }
      }
      initTable(copyBillData, 'table')
      let monthList = [{ label: '全部', value: -1 }]
      for (let i = 1; i < 13; i++) {
        monthList.push({ label: i, value: i })
      }
      initSelect(monthList, 'select')
      bindEvent('select', value => {
        copyBillData.data = billData.data.filter(item => {
          if (Number(value) === -1) return true
          let timerMonth = item.time.split('-')[1]
          return Number(timerMonth) === Number(value)
        })
        initTable(copyBillData, 'table')
      })
    </script>
  </body>
</html>