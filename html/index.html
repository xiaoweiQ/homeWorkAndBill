<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="../bill.js"></script>
    <script src="../categories.js"></script>
    <link rel="stylesheet" href="./modal.css" />
    <link rel="stylesheet" href="./calendar.css">
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      table tr th,
      table tr td {
        min-width: 100px;
        border: 1px solid red;
        text-align: center;
      }
      .form-div {
        display: flex;
        margin-bottom: 10px;
        width: 200px
      }
      button {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        height: 32px;
        padding: 8px 15px;
        margin: 2px;
        cursor: pointer;
        color: #fff;
        text-align: center;
        outline: none;
        font-weight: 500;
        user-select: none;
        background-color: #409eff;
        border: none;
        font-size: 14px;
        border-radius: 4px;
      }
      label {
        display: block;
        min-width: 100px;
      }
      .sum {
        display: flex;
        width: 520px;
        justify-content: space-between
      }
      #add-bill-time_date {
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <select class="monthType"></select>
      <select class="billCategory"></select>
      <button class="addBill">添加账单</button>
      <div class="modal-wrap">
        <div class="modal">
          <div class="modal_header">
            <div class="modal_header-title">添加账单</div>
            <div class="modal_header-close">x</div>
          </div>
          <div class="modal_content">
            <form class="bill-form">
              <div class="form-div">
                <label>账单类型</label>
                <select style="width: 100px" class="modal-content_bill-type"></select>
              </div>
              <div class="form-div">
                <label>账单时间</label>
                <div id="add-bill-time_date">
                  <input style="width: 100px" class="modal-content_bill-time-input" type="text"></input>
                  <div class="modal-content_bill-time"></div>
                </div>
              </div>
              <div class="form-div">
                <label>账单分类</label>
                <select style="width: 100px" class="modal-content_bill-category"></select>
              </div>
              <div class="form-div">
                <label>账单金额</label>
                <input style="width: 100px" type="number" class="modal-content_bill-amount"></input>
              </div>
            </form>
          </div>
          <div class="modal_footer">
            <button class="add-bill-confirm">确定</button>
            <button class="add-bill-cancel">取消</button>
          </div>
        </div>
        <div class="overlay"></div>
      </div>
      <table class="table"></table>
      <div class="sum"></div>
    </div>
    <script type="module">
      import { txtToJson, dispose, deepClone, generateTimerList, findParentNode } from './util.js'
      import { loadPickDate } from "./pickDate.js";
      let billData = txtToJson(billText)
      let categoriesData = txtToJson(categoriesText)
      let filterBillData = dispose(billData, categoriesData)

      function initTable(data, tableClassName) {
        // 移除旧的table
        let table = document.querySelector(`.${tableClassName}`)
        if (table) {
          let parent = table.parentElement
          parent.removeChild(table)
        }
        // 生成新的table标签
        let wrap = document.querySelector('.wrap')
        let newTable = document.createElement('table')
        newTable.setAttribute('class', 'table')
        wrap.appendChild(newTable)
        const appendTitles = titles => {
          let tr = document.createElement('tr')
          newTable.appendChild(tr)
          titles.forEach(title => {
            let th = document.createElement('th')
            tr.appendChild(th)
            th.innerText = title
          })
        }
        const appendContents = contents => {
          contents.forEach(content => {
            let tr = document.createElement('tr')
            newTable.appendChild(tr)
            for (const key in content) {
              let td = document.createElement('td')
              tr.appendChild(td)
              td.innerText = content[key]
            }
          })
        }
        let titles = data.titles
        let contents = data.data
        appendTitles(titles)
        appendContents(contents)
        renderSum(data)
      }
      function initSelect(selectDom, data) {
        let select = document.querySelector(selectDom)
        data.forEach(item => {
          let option = document.createElement('option')
          select.appendChild(option)
          option.innerText = item.label
          option.value = item.value
        })
      }
      function bindEvent(domName, eventName, cb) {
        let ele = document.querySelector(domName)
        ele[eventName] = e => {
          cb(e, ele)
        }
      }
      function getSum(type, data) {
        let sum = 0
        switch (type) {
          case 0:
            return data.data.filter(item => item.type === '支出').map(item => Number(item.amount)).reduce((prev, current) => prev + current, 0)
          case 1:
            return data.data.filter(item => item.type === '收入').map(item => Number(item.amount)).reduce((prev, current) => prev + current, 0)
          default:
            break;
        }
      }
      function renderSum(data) {
        // 移除dom
        let sumDiv = document.querySelector('.sum')
        if (sumDiv) {
          let parent = sumDiv.parentElement
          parent.removeChild(sumDiv)
        }
        let wrap = document.querySelector('.wrap')
        let newSumDiv = document.createElement('div')
        newSumDiv.setAttribute('class', 'sum')
        // 设置收入金额dom
        let income = document.createElement('div')
        income.style.color = 'green'
        income.innerText = '收入金额：' + getSum(1, data)
        // 设置支持金额dom
        let spending = document.createElement('spending')
        spending.style.color = 'red'
        spending.innerText = '支出金额：' + getSum(0, data)
        // 添加dom到根结点
        wrap.appendChild(newSumDiv)
        newSumDiv.appendChild(income)
        newSumDiv.appendChild(spending)
      }
      initTable(filterBillData, 'table')

      let monthList = [{ label: '全部', value: '' }]
      for (let i = 1; i < 13; i++) {
        monthList.push({ label: i, value: i })
      }
      let billCategoryList = [{ label: '全部', value: '' }]
      for (let i = 1; i < categoriesData.data.length; i++) {
        let categorieInfo = categoriesData.data[i]
        billCategoryList.push({ label: categorieInfo.name, value: categorieInfo.id })
      }
      initSelect('.monthType', monthList)
      initSelect('.billCategory', billCategoryList)
      let searchParams = {
        month: '',
        category: ''
      }
      function handleSearch(params) {
        let tempData = deepClone(billData)
        tempData.data = billData.data.filter(item => {
          let timerMonth = new Date(Number(item.time)).toISOString().split('-')[1]
          if (!params.month) {
            if (params.category) {
              return params.category === item.category
            }
          }
          if (!params.category) {
            if (params.month) {
              return Number(timerMonth) === Number(params.month)
            }
          }
          if (params.month && params.category) {
            return params.category === item.category && Number(timerMonth) === Number(params.month)
          }
          return true
        })
        tempData = dispose(tempData, categoriesData)
        initTable(tempData, 'table')
      }
      
      bindEvent('.monthType', 'onchange', (e, ele) => {
        let selectedIndex = ele.selectedIndex
        let selectedValue = ele.options[selectedIndex].value
        searchParams.month = selectedValue
        handleSearch(searchParams)
      })
      bindEvent('.billCategory', 'onchange', (e, ele) => {
        let selectedIndex = ele.selectedIndex
        let selectedValue = ele.options[selectedIndex].value
        searchParams.category = selectedValue
        handleSearch(searchParams)
      })
      bindEvent('.addBill', 'onclick', (e, ele) => {
        let modalWrap = document.querySelector('.modal-wrap')
        modalWrap.style.display = 'block'
        let body = document.querySelector('body')
        body.style.overflow = 'hidden'
      })
      const initBillModal = () => {
        let modalWrap = document.querySelector('.modal-wrap')
        let confirmBtn = document.querySelector('.add-bill-confirm')
        // 点击确认后添加元素
        confirmBtn.onclick = (e) => {
          let addBillForm = document.querySelector('.bill-form')
          // 获取表单的内容
          let billType = document.querySelector('.modal-content_bill-type')
          let billTime = document.querySelector('.modal-content_bill-time-input')
          let billCategory = document.querySelector('.modal-content_bill-category')
          let billAmount = document.querySelector('.modal-content_bill-amount')
          
          let billTimeList = billTime.value.split('-')
          let formResult = {
            type: billType.value,
            time: billTime.value ? new Date(billTimeList[0], billTimeList[1], billTimeList[2]) : '',
            category: billCategory.value,
            amount: billAmount.value
          }
          if (!formResult.type) {
            alert('请选择账单类型!')
            return
          }
          if (!formResult.time) {
            alert('请选择账单时间!')
            return
          }
          if (!formResult.category) {
            alert('请选择账单分类!')
            return
          }
          if (!formResult.amount) {
            alert('请输入账单金额!')
            return
          }
          let tempList = { titles: [], data: [formResult] }
          let filterTempList = dispose(tempList, categoriesData)
          billData.data.push(...filterTempList.data)
          filterBillData = deepClone(billData)
          initTable(filterBillData, 'table')
          closeModal()
        }
        const closeModal = () => {
          modalWrap.style.display = 'none'
          let body = document.querySelector('body')
          body.style.overflow = 'auto'
        }
        // 绑定modal中的关闭弹框事件
        bindEvent('.modal_header-close', 'onclick', closeModal)
        bindEvent('.add-bill-cancel', 'onclick', closeModal)
        bindEvent('.overlay', 'onclick', closeModal)
      }
      initBillModal()
      const addBillModalContent = () => {
        // 创建表单
        let modalContent = document.querySelector('.modal_content')
        let form = document.createElement('form')
        form.setAttribute('class', 'bill-form')
        modalContent.appendChild(form)
        // 初始化表单数据
        let billTypeList = [{ label: '支出', value: '0' }, { label: '收入', value: '1' }]
        let billCategoryList = categoriesData.data.map(item => {
          return {
            label: item.name,
            value: item.id
          }
        })
        initSelect('.modal-content_bill-type', billTypeList)
        initSelect('.modal-content_bill-category', billCategoryList)

        let billTimeInput = document.querySelector('.modal-content_bill-time-input')
        let billTime = document.querySelector('.modal-content_bill-time')
        billTimeInput.onclick = () => {
          if (billTime.style.display === 'none' || billTime.style.display === '') {
            billTime.setAttribute('style', 'display: block');
            // 默认绑定点击事件
            loadPickDate('.modal-content_bill-time', e => {
              billTimeInput.value = e.value.join('-')
              billTime.setAttribute('style', 'display: none');
            })
          }
        }
        document.onclick = (e) => {
          let target = e.target
          let isFindInput = findParentNode(target, billTimeInput)
          let isFindPickDate = findParentNode(target, billTime)
          if (!isFindInput && !isFindPickDate) {
            billTime.setAttribute('style', 'display: none');
          }
        }
      }
      addBillModalContent()
    </script>
  </body>
</html>